---
# Ansible Playbook for Semaphore UI with Enum Survey
# This version handles different possible variable names from Semaphore

- name: Install Shared Printers on Windows Desktops
  hosts: windows-desktops
  gather_facts: no

  vars:
    print_server: "HVTRM-WS-PRNT.caliksoa.local"

    # Printer definitions - Add new printers here
    printer_definitions:
      MRK-K0-BT-Konica-224-Color:
        name: "MRK-K0-BT-Konica-224-Color"
        share_path: "\\\\{{ print_server }}\\MRK-K0-BT-Konica-224-Color"
        description: "Konica 224 Color Printer - Basement"
      MRK-K1-Vize-Konica-C301-Color:
        name: "MRK-K1-Vize-Konica-C301-Color"
        share_path: "\\\\{{ print_server }}\\MRK-K1-Vize-Konica-C301-Color"
        description: "Konica C301 Color Printer - Floor 1"

    # Default empty - will be populated by survey
    printers_to_install_names: []
    
    # Alternative variable names that Semaphore might use
    printer_selection: []
    selected_printers: []
    printers: []

  tasks:
    - name: Debug - Show all possible survey variables
      debug:
        msg:
          - "printers_to_install_names: {{ printers_to_install_names | default([]) }}"
          - "printer_selection: {{ printer_selection | default([]) }}"
          - "selected_printers: {{ selected_printers | default([]) }}"
          - "printers: {{ printers | default([]) }}"
          - "All vars: {{ vars.keys() | select('match', '.*printer.*') | list }}"

    - name: Determine which variable contains the selection
      set_fact:
        selected_printer_names: >-
          {{
            printers_to_install_names if (printers_to_install_names | default([]) | length > 0)
            else (printer_selection if (printer_selection | default([]) | length > 0)
            else (selected_printers if (selected_printers | default([]) | length > 0)
            else (printers if (printers | default([]) | length > 0)
            else [])))
          }}

    - name: Display what we received
      debug:
        msg: "Received printer selection: {{ selected_printer_names }}"

    - name: Validate that printers were selected
      fail:
        msg: |
          No printers selected from survey!
          
          Please select at least one printer from the dropdown in Semaphore.
          
          Debug info - none of these variables contained data:
          - printers_to_install_names: {{ printers_to_install_names | default([]) }}
          - printer_selection: {{ printer_selection | default([]) }}
          - selected_printers: {{ selected_printers | default([]) }}
          - printers: {{ printers | default([]) }}
      when: selected_printer_names | length == 0

    - name: Build full printer objects from selected names
      set_fact:
        printers_to_install: "{{ printers_to_install | default([]) + [printer_definitions[item]] }}"
      loop: "{{ selected_printer_names }}"
      when: item in printer_definitions.keys()

    - name: Warn about invalid printer names
      debug:
        msg: "WARNING: '{{ item }}' is not a valid printer name and will be skipped"
      loop: "{{ selected_printer_names }}"
      when: item not in printer_definitions.keys()

    - name: Display installation plan
      debug:
        msg: |
          ============================================
          Installation Plan for: {{ inventory_hostname }}
          ============================================
          Printers to install:
          {% for printer in printers_to_install %}
          + {{ printer.name }}
            Location: {{ printer.description }}
            Path: {{ printer.share_path }}
          {% endfor %}
          ============================================

    - name: Ensure Print Spooler service is running
      ansible.windows.win_service:
        name: Spooler
        start_mode: auto
        state: started
      register: spooler_result

    - name: Display Spooler status
      debug:
        msg: "Print Spooler service is {{ spooler_result.state }}"

    - name: Install selected printers using PowerShell
      ansible.windows.win_shell: |
        $printerName = "{{ item.name }}"
        $printerPath = "{{ item.share_path }}"
        
        # Check if printer already exists
        $existingPrinter = Get-Printer -Name $printerName -ErrorAction SilentlyContinue
        
        if ($existingPrinter) {
            Write-Output "ALREADY_EXISTS"
            exit 0
        }
        
        # Add the printer
        try {
            Add-Printer -ConnectionName $printerPath -ErrorAction Stop
            Write-Output "INSTALLED"
            exit 0
        } catch {
            Write-Output "ERROR: $($_.Exception.Message)"
            exit 1
        }
      loop: "{{ printers_to_install }}"
      register: printer_install_results
      changed_when: "'INSTALLED' in item.stdout"
      failed_when: "'ERROR' in item.stdout"

    - name: Generate installation summary
      set_fact:
        installation_summary: |
          ============================================
          INSTALLATION SUMMARY
          ============================================
          Host: {{ inventory_hostname }}
          Print Spooler: {{ 'Running [OK]' if spooler_result.state == 'started' else 'Issue [ERROR]' }}
          
          Printer Installation Results:
          {% for result in printer_install_results.results %}
          {% if 'INSTALLED' in result.stdout %}
          [+] {{ result.item.name }}: Newly Installed
          {% elif 'ALREADY_EXISTS' in result.stdout %}
          [=] {{ result.item.name }}: Already Present
          {% else %}
          [!] {{ result.item.name }}: Check logs for details
          {% endif %}
          {% endfor %}
          ============================================

    - name: Display installation summary
      debug:
        msg: "{{ installation_summary }}"