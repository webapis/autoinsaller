- name: Install Printer (Authenticated Session)
  win_shell: |
    $ErrorActionPreference = 'Stop'
    $server = "{{ print_server }}"
    $printer = "{{ printer_name | replace('[', '') | replace(']', '') | replace('\"', '') }}"
    $user = "{{ share_user }}"
    $pass = "{{ share_password }}"
    $fullPath = "\\$server\$printer"

    try {
        # 1. Authenticate to print server
        $netArgs = @("use", "\\$server\IPC$", "/user:$user", "$pass")
        $netResult = & net.exe $netArgs 2>&1
        if ($LASTEXITCODE -ne 0) {
            Write-Warning "Authentication result: $netResult"
        }

        # 2. Install printer globally
        $printArgs = "printui.dll,PrintUIEntry /ga /n`"$fullPath`" /q"
        $process = Start-Process rundll32.exe -ArgumentList $printArgs -Wait -PassThru
        
        Write-Host "PrintUI exit code: $($process.ExitCode)"
        
        # 3. Restart spooler to register the printer
        Restart-Service Spooler -Force
        Start-Sleep -Seconds 10

        # 4. Verify installation (check registry instead of Get-Printer)
        # Global printers are stored in HKLM
        $regPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Print\Connections"
        $printerFound = $false
        
        if (Test-Path $regPath) {
            $connections = Get-ChildItem -Path $regPath -ErrorAction SilentlyContinue
            foreach ($conn in $connections) {
                if ($conn.PSChildName -like "*$printer*") {
                    $printerFound = $true
                    Write-Host "Printer connection found in registry: $($conn.PSChildName)"
                    break
                }
            }
        }
        
        # Also check WMI for printer ports
        $wmiPrinter = Get-WmiObject -Class Win32_Printer | Where-Object { 
            $_.Name -like "*$printer*" -or $_.ShareName -like "*$printer*" 
        }
        
        if ($wmiPrinter) {
            $printerFound = $true
            Write-Host "Printer found via WMI: $($wmiPrinter.Name)"
        }
        
        if ($printerFound) {
            Write-Host "SUCCESS: Printer installed globally"
            exit 0
        } else {
            Write-Warning "Printer may be installed but not immediately visible"
            Write-Host "Users should see the printer after they log in"
            exit 0
        }
    }
    catch {
        Write-Error "Installation failed: $($_.Exception.Message)"
        exit 1
    }
    finally {
        # Cleanup authentication
        & net.exe use "\\$server\IPC$" /delete 2>&1 | Out-Null
    }
  register: printer_install
  changed_when: "'SUCCESS' in printer_install.stdout"