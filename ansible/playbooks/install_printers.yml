- name: Install Printer (Authenticated Session)
  win_shell: |
    $ErrorActionPreference = 'Stop'
    $server = "{{ print_server }}"
    $printer = "{{ printer_name | replace('[', '') | replace(']', '') | replace('"', '') }}"
    $user = "{{ share_user }}"
    $pass = "{{ share_password }}"
    $fullPath = "\\$server\$printer"

    try {
        Write-Host "Authenticating to $server..."
        $netArgs = @("use", "\\$server\IPC$", "/user:$user", "$pass")
        $netResult = & net.exe $netArgs 2>&1
        if ($LASTEXITCODE -ne 0) {
            Write-Warning "Authentication failed: $netResult"
            throw "Authentication failed"
        }
        Write-Host "Authentication successful"

        Write-Host "Installing printer globally: $fullPath"
        $printArgs = "printui.dll,PrintUIEntry /ga /n`"$fullPath`" /q"
        Start-Process rundll32.exe -ArgumentList $printArgs -Wait -NoNewWindow

        Write-Host "Restarting Print Spooler..."
        Restart-Service Spooler -Force
        Start-Sleep -Seconds 15

        # Verification - relaxed
        $printerFound = $false
        $regPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Print\Connections"
        if (Test-Path $regPath) {
            $connections = Get-ChildItem -Path $regPath -ErrorAction SilentlyContinue
            foreach ($conn in $connections) {
                if ($conn.PSChildName -like "*$printer*") {
                    $printerFound = $true
                    Write-Host "Printer found in registry: $($conn.PSChildName)"
                    break
                }
            }
        }

        if (-not $printerFound) {
            $wmiPrinter = Get-WmiObject -Class Win32_Printer | Where-Object { $_.Name -like "*$printer*" -or $_.ShareName -like "*$printer*" }
            if ($wmiPrinter) {
                $printerFound = $true
                Write-Host "Printer found via WMI: $($wmiPrinter.Name)"
            }
        }

        if ($printerFound) {
            Write-Host "SUCCESS: Printer installed globally"
        } else {
            Write-Host "INFO: Global add executed. Printer may appear after logoff/logon or a few minutes."
        }

        exit 0
    }
    catch {
        Write-Error "Installation failed: $($_.Exception.Message)"
        exit 1
    }
    finally {
        Write-Host "Cleaning up authentication session..."
        & net.exe use "\\$server\IPC$" /delete 2>&1 | Out-Null
    }
  register: printer_install
  changed_when: "'SUCCESS' in printer_install.stdout or 'INFO: Global add executed' in printer_install.stdout"
  failed_when: printer_install.rc != 0 and 'Authentication failed' in printer_install.stderr
  ignore_errors: true  # Optional: continue even if verification fails