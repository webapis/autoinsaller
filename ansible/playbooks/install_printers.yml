---
# Ansible Playbook for Semaphore UI with Enum Survey
# Diagnostic version to discover available printer shares

- name: Install Shared Printers on Windows Desktops
  hosts: windows-desktops
  gather_facts: no

  vars:
    print_server: "HVTRM-WS-PRNT.caliksoa.local"

    printer_definitions:
      MRK-K0-BT-Konica-224-Color:
        name: "MRK-K0-BT-Konica-224-Color"
        server: "HVTRM-WS-PRNT.caliksoa.local"
        share: "MRK-K0-BT-Konica-224-Color"
        description: "Konica 224 Color Printer - Basement"
      MRK-K1-Vize-Konica-C301-Color:
        name: "MRK-K1-Vize-Konica-C301-Color"
        server: "HVTRM-WS-PRNT.caliksoa.local"
        share: "MRK-K1-Vize-Konica-C301-Color"
        description: "Konica C301 Color Printer - Floor 1"

    printers_to_install: []

  tasks:
    - name: Debug raw survey input
      debug:
        var: printers_to_install

    - name: Normalize survey input to always be a list
      set_fact:
        selected_printer_names: >-
          {{ [printers_to_install] if printers_to_install | length > 0 else [] }}

    - name: Display normalized selection
      debug:
        msg: "Normalized printer selection: {{ selected_printer_names }}"

    - name: Validate that printers were selected
      fail:
        msg: |
          No printers selected from survey!
          
          Please select at least one printer in Semaphore.
      when: selected_printer_names | length == 0

    - name: Build full printer objects from selected names
      set_fact:
        printers_to_install_objects: "{{ printers_to_install_objects | default([]) + [printer_definitions[item]] }}"
      loop: "{{ selected_printer_names }}"
      when: item in printer_definitions.keys()

    - name: Warn about invalid printer names
      debug:
        msg: "WARNING: '{{ item }}' is not a valid printer name and will be skipped"
      loop: "{{ selected_printer_names }}"
      when: item not in printer_definitions.keys()

    - name: Display installation plan
      debug:
        msg: |
          ============================================
          Installation Plan for: {{ inventory_hostname }}
          ============================================
          Printers to install:
          {% for printer in printers_to_install_objects | default([]) %}
          + {{ printer.name }}
            Location: {{ printer.description }}
            Server: {{ printer.server }}
            Share: {{ printer.share }}
          {% endfor %}
          ============================================

    - name: Discover available printer shares on server
      ansible.windows.win_shell: |
        $server = "{{ print_server }}"
        
        Write-Output "=== Discovering Printer Shares on $server ==="
        
        # Method 1: Try to list network shares
        try {
            $shares = Get-WmiObject -Class Win32_Share -ComputerName $server -Filter "Type=0" | Where-Object { $_.Name -like "*print*" -or $_.Name -like "*MRK*" }
            if ($shares) {
                Write-Output "Found shares (WMI):"
                foreach ($share in $shares) {
                    Write-Output "  - $($share.Name) : $($share.Path)"
                }
            } else {
                Write-Output "No printer-related shares found via WMI"
            }
        } catch {
            Write-Output "WMI query failed: $($_.Exception.Message)"
        }
        
        # Method 2: Try to enumerate printers using CIM
        try {
            Write-Output ""
            Write-Output "Attempting to list printers via Get-Printer:"
            $printers = Get-Printer -ComputerName $server -ErrorAction Stop
            Write-Output "Found $($printers.Count) printer(s):"
            foreach ($printer in $printers) {
                Write-Output "  - Name: $($printer.Name)"
                Write-Output "    ShareName: $($printer.ShareName)"
                Write-Output "    Shared: $($printer.Shared)"
            }
        } catch {
            Write-Output "Get-Printer failed: $($_.Exception.Message)"
        }
        
        # Method 3: Try net view
        try {
            Write-Output ""
            Write-Output "Attempting net view:"
            $netView = net view "\\$server" 2>&1
            Write-Output $netView
        } catch {
            Write-Output "Net view failed: $($_.Exception.Message)"
        }
      register: printer_discovery
      changed_when: false
      failed_when: false

    - name: Display discovered printers
      debug:
        var: printer_discovery.stdout_lines

    - name: Ensure Print Spooler service is running
      ansible.windows.win_service:
        name: Spooler
        start_mode: auto
        state: started
      register: spooler_result

    - name: Display Spooler status
      debug:
        msg: "Print Spooler service is {{ spooler_result.state }}"

    - name: Install selected printers using PowerShell
      ansible.windows.win_shell: |
        $printerName = "{{ item.name }}"
        $printerServer = "{{ item.server }}"
        $printerShare = "{{ item.share }}"
        $printerPath = "\\$printerServer\$printerShare"
        
        Write-Output "Attempting to add printer: $printerName"
        Write-Output "UNC Path: $printerPath"
        
        # Check if printer already exists
        $existingPrinter = Get-Printer -Name $printerName -ErrorAction SilentlyContinue
        
        if ($existingPrinter) {
            Write-Output "ALREADY_EXISTS"
            exit 0
        }
        
        # Attempt to add the printer
        try {
            Add-Printer -ConnectionName $printerPath -ErrorAction Stop
            Write-Output "INSTALLED"
            exit 0
        } catch {
            Write-Output "ERROR: $($_.Exception.Message)"
            
            # Try alternate method with explicit port
            Write-Output "Attempting alternate installation method..."
            try {
                # Try using the printer name directly as connection
                $altPath = "\\$printerServer\$printerName"
                Add-Printer -ConnectionName $altPath -ErrorAction Stop
                Write-Output "INSTALLED_ALT"
                exit 0
            } catch {
                Write-Output "ERROR_ALT: $($_.Exception.Message)"
                exit 1
            }
        }
      loop: "{{ printers_to_install_objects | default([]) }}"
      register: printer_install_results
      changed_when: "'INSTALLED' in printer_install_results.stdout"
      failed_when: "'ERROR_ALT:' in printer_install_results.stdout and 'INSTALLED' not in printer_install_results.stdout"

    - name: Generate installation summary
      set_fact:
        installation_summary: |
          ============================================
          INSTALLATION SUMMARY
          ============================================
          Host: {{ inventory_hostname }}
          Print Server: {{ print_server }}
          Print Spooler: {{ 'Running [OK]' if spooler_result.state == 'started' else 'Issue [ERROR]' }}
          
          Printer Installation Results:
          {% for result in printer_install_results.results %}
          {% if 'INSTALLED' in result.stdout %}
          [+] {{ result.item.name }}: Successfully Installed
          {% elif 'ALREADY_EXISTS' in result.stdout %}
          [=] {{ result.item.name }}: Already Present
          {% else %}
          [!] {{ result.item.name }}: Failed - See details below
          {% endif %}
          {% endfor %}
          
          {% for result in printer_install_results.results %}
          {% if 'ERROR:' in result.stdout %}
          
          Error Details for {{ result.item.name }}:
          {{ result.stdout }}
          {% endif %}
          {% endfor %}
          ============================================

    - name: Display installation summary
      debug:
        msg: "{{ installation_summary }}"