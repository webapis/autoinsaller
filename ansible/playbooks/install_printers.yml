---
# Ansible Playbook for Semaphore UI with Enum Survey
# Handles single-value string from Semaphore Enum survey (compatible with older Ansible)

- name: Install Shared Printers on Windows Desktops
  hosts: windows-desktops
  gather_facts: no

  vars:
    print_server: "HVTRM-WS-PRNT.caliksoa.local"

    printer_definitions:
      MRK-K0-BT-Konica-224-Color:
        name: "MRK-K0-BT-Konica-224-Color"
        share_path: "\\\\{{ print_server }}\\MRK-K0-BT-Konica-224-Color"
        description: "Konica 224 Color Printer - Basement"
      MRK-K1-Vize-Konica-C301-Color:
        name: "MRK-K1-Vize-Konica-C301-Color"
        share_path: "\\\\{{ print_server }}\\MRK-K1-Vize-Konica-C301-Color"
        description: "Konica C301 Color Printer - Floor 1"

    printers_to_install: []

  tasks:
    - name: Debug raw survey input
      debug:
        var: printers_to_install

    - name: Normalize survey input to always be a list
      set_fact:
        selected_printer_names: >-
          {{
            printers_to_install | default([])
            if printers_to_install is_list
            else [printers_to_install]
            if printers_to_install is string
            else []
          }}

    - name: Display normalized selection
      debug:
        msg: "Normalized printer selection: {{ selected_printer_names }}"

    - name: Validate that printers were selected
      fail:
        msg: |
          No printers selected from survey!
          
          Please select at least one printer in Semaphore.
      when: selected_printer_names | length == 0

    - name: Build full printer objects from selected names
      set_fact:
        printers_to_install_objects: "{{ printers_to_install_objects | default([]) + [printer_definitions[item]] }}"
      loop: "{{ selected_printer_names }}"
      when: item in printer_definitions

    - name: Warn about invalid printer names
      debug:
        msg: "WARNING: '{{ item }}' is not a valid printer name and will be skipped"
      loop: "{{ selected_printer_names }}"
      when: item not in printer_definitions

    - name: Display installation plan
      debug:
        msg: |
          ============================================
          Installation Plan for: {{ inventory_hostname }}
          ============================================
          Printers to install:
          {% for printer in printers_to_install_objects %}
          + {{ printer.name }}
            Location: {{ printer.description }}
            Path: {{ printer.share_path }}
          {% endfor %}
          ============================================

    - name: Ensure Print Spooler service is running
      ansible.windows.win_service:
        name: Spooler
        start_mode: auto
        state: started
      register: spooler_result

    - name: Display Spooler status
      debug:
        msg: "Print Spooler service is {{ spooler_result.state }}"

    - name: Install selected printers using PowerShell
      ansible.windows.win_shell: |
        $printerName = "{{ item.name }}"
        $printerPath = "{{ item.share_path }}"
        
        # Check if printer already exists
        $existingPrinter = Get-Printer -Name $printerName -ErrorAction SilentlyContinue
        
        if ($existingPrinter) {
            Write-Output "ALREADY_EXISTS"
            exit 0
        }
        
        # Add the printer
        try {
            Add-Printer -ConnectionName $printerPath -ErrorAction Stop
            Write-Output "INSTALLED"
            exit 0
        } catch {
            Write-Output "ERROR: $($_.Exception.Message)"
            exit 1
        }
      loop: "{{ printers_to_install_objects }}"
      register: printer_install_results
      changed_when: "'INSTALLED' in item.stdout"
      failed_when: "'ERROR' in item.stdout"

    - name: Generate installation summary
      set_fact:
        installation_summary: |
          ============================================
          INSTALLATION SUMMARY
          ============================================
          Host: {{ inventory_hostname }}
          Print Spooler: {{ 'Running [OK]' if spooler_result.state == 'started' else 'Issue [ERROR]' }}
          
          Printer Installation Results:
          {% for result in printer_install_results.results %}
          {% if 'INSTALLED' in result.stdout %}
          [+] {{ result.item.name }}: Newly Installed
          {% elif 'ALREADY_EXISTS' in result.stdout %}
          [=] {{ result.item.name }}: Already Present
          {% else %}
          [!] {{ result.item.name }}: Check logs for details
          {% endif %}
          {% endfor %}
          ============================================

    - name: Display installation summary
      debug:
        msg: "{{ installation_summary }}"