---
# Ansible Playbook for Semaphore UI with Enum Survey
# Compatible with older Ansible versions
# Added network connectivity test and better diagnostics

- name: Install Shared Printers on Windows Desktops
  hosts: windows-desktops
  gather_facts: no

  vars:
    print_server: "HVTRM-WS-PRNT.caliksoa.local"

    printer_definitions:
      MRK-K0-BT-Konica-224-Color:
        name: "MRK-K0-BT-Konica-224-Color"
        server: "HVTRM-WS-PRNT.caliksoa.local"
        share: "MRK-K0-BT-Konica-224-Color"
        description: "Konica 224 Color Printer - Basement"
      MRK-K1-Vize-Konica-C301-Color:
        name: "MRK-K1-Vize-Konica-C301-Color"
        server: "HVTRM-WS-PRNT.caliksoa.local"
        share: "MRK-K1-Vize-Konica-C301-Color"
        description: "Konica C301 Color Printer - Floor 1"

    printers_to_install: []

  tasks:
    - name: Debug raw survey input
      debug:
        var: printers_to_install

    - name: Normalize survey input to always be a list
      set_fact:
        selected_printer_names: >-
          {{ [printers_to_install] if printers_to_install | length > 0 else [] }}

    - name: Display normalized selection
      debug:
        msg: "Normalized printer selection: {{ selected_printer_names }}"

    - name: Validate that printers were selected
      fail:
        msg: |
          No printers selected from survey!
          
          Please select at least one printer in Semaphore.
      when: selected_printer_names | length == 0

    - name: Build full printer objects from selected names
      set_fact:
        printers_to_install_objects: "{{ printers_to_install_objects | default([]) + [printer_definitions[item]] }}"
      loop: "{{ selected_printer_names }}"
      when: item in printer_definitions.keys()

    - name: Warn about invalid printer names
      debug:
        msg: "WARNING: '{{ item }}' is not a valid printer name and will be skipped"
      loop: "{{ selected_printer_names }}"
      when: item not in printer_definitions.keys()

    - name: Display installation plan
      debug:
        msg: |
          ============================================
          Installation Plan for: {{ inventory_hostname }}
          ============================================
          Printers to install:
          {% for printer in printers_to_install_objects | default([]) %}
          + {{ printer.name }}
            Location: {{ printer.description }}
            Server: {{ printer.server }}
            Share: {{ printer.share }}
          {% endfor %}
          ============================================

    - name: Test connectivity to print server
      ansible.windows.win_shell: |
        $server = "{{ print_server }}"
        $result = Test-Connection -ComputerName $server -Count 1 -Quiet
        if ($result) {
            Write-Output "REACHABLE"
        } else {
            Write-Output "UNREACHABLE"
        }
      register: server_connectivity
      changed_when: false

    - name: Display connectivity status
      debug:
        msg: "Print server {{ print_server }} is {{ 'REACHABLE' if 'REACHABLE' in server_connectivity.stdout else 'UNREACHABLE' }}"

    - name: Ensure Print Spooler service is running
      ansible.windows.win_service:
        name: Spooler
        start_mode: auto
        state: started
      register: spooler_result

    - name: Display Spooler status
      debug:
        msg: "Print Spooler service is {{ spooler_result.state }}"

    - name: Install selected printers using PowerShell
      ansible.windows.win_shell: |
        $printerName = "{{ item.name }}"
        $printerServer = "{{ item.server }}"
        $printerShare = "{{ item.share }}"
        $printerPath = "\\$printerServer\$printerShare"
        
        Write-Output "Attempting to add printer: $printerName"
        Write-Output "UNC Path: $printerPath"
        
        # Check if printer already exists
        $existingPrinter = Get-Printer -Name $printerName -ErrorAction SilentlyContinue
        
        if ($existingPrinter) {
            Write-Output "ALREADY_EXISTS"
            exit 0
        }
        
        # Try to list available printers on the server to verify connectivity
        try {
            $availablePrinters = Get-Printer -ComputerName $printerServer -ErrorAction Stop
            Write-Output "Found $($availablePrinters.Count) printers on server"
        } catch {
            Write-Output "WARNING: Cannot list printers on server: $($_.Exception.Message)"
        }
        
        # Attempt to add the printer
        try {
            Add-Printer -ConnectionName $printerPath -ErrorAction Stop
            Write-Output "INSTALLED"
            exit 0
        } catch {
            Write-Output "ERROR: $($_.Exception.Message)"
            Write-Output "ERROR_DETAIL: Failed to connect to $printerPath"
            exit 1
        }
      loop: "{{ printers_to_install_objects | default([]) }}"
      register: printer_install_results
      changed_when: "'INSTALLED' in printer_install_results.stdout"
      failed_when: "'ERROR:' in printer_install_results.stdout"

    - name: Generate installation summary
      set_fact:
        installation_summary: |
          ============================================
          INSTALLATION SUMMARY
          ============================================
          Host: {{ inventory_hostname }}
          Print Server: {{ print_server }} [{{ 'REACHABLE' if 'REACHABLE' in server_connectivity.stdout else 'UNREACHABLE' }}]
          Print Spooler: {{ 'Running [OK]' if spooler_result.state == 'started' else 'Issue [ERROR]' }}
          
          Printer Installation Results:
          {% for result in printer_install_results.results %}
          {% if 'INSTALLED' in result.stdout %}
          [+] {{ result.item.name }}: Newly Installed
          {% elif 'ALREADY_EXISTS' in result.stdout %}
          [=] {{ result.item.name }}: Already Present
          {% else %}
          [!] {{ result.item.name }}: Failed - Check details below
          {% endif %}
          {% endfor %}
          
          {% for result in printer_install_results.results %}
          {% if 'ERROR:' in result.stdout %}
          
          Error Details for {{ result.item.name }}:
          {{ result.stdout }}
          {% endif %}
          {% endfor %}
          ============================================

    - name: Display installation summary
      debug:
        msg: "{{ installation_summary }}"