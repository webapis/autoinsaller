- name: Install Printer (Authenticated Session)
  win_shell: |
    $ErrorActionPreference = 'Stop'
    $server = "{{ print_server }}"
    $printer = "{{ printer_name | replace('[', '') | replace(']', '') | replace('\"', '') }}"
    $user = "{{ share_user }}"
    $pass = "{{ share_password }}"
    $fullPath = "\\$server\$printer"

    try {
        # 1. Authenticate to print server
        Write-Host "Authenticating to $server..."
        $netArgs = @("use", "\\$server\IPC$", "/user:$user", "$pass")
        $netResult = & net.exe $netArgs 2>&1
        if ($LASTEXITCODE -ne 0) {
            Write-Warning "Authentication result: $netResult"
        } else {
            Write-Host "Authentication successful"
        }

        # 2. Install printer globally using printui.dll
        Write-Host "Installing printer: $fullPath"
        $printArgs = "printui.dll,PrintUIEntry /ga /n`"$fullPath`" /q"
        $process = Start-Process rundll32.exe -ArgumentList $printArgs -Wait -PassThru
        
        Write-Host "PrintUI exit code: $($process.ExitCode)"
        
        # 3. Restart spooler to register the printer
        Write-Host "Restarting Print Spooler..."
        Restart-Service Spooler -Force
        Start-Sleep -Seconds 10

        # 4. Verify installation
        Write-Host "Verifying installation..."
        $printerFound = $false
        
        # Check registry for global printer connections
        $regPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Print\Connections"
        if (Test-Path $regPath) {
            $connections = Get-ChildItem -Path $regPath -ErrorAction SilentlyContinue
            foreach ($conn in $connections) {
                if ($conn.PSChildName -like "*$printer*") {
                    $printerFound = $true
                    Write-Host "Printer connection found in registry: $($conn.PSChildName)"
                    break
                }
            }
        }
        
        # Check WMI for installed printers
        $wmiPrinter = Get-WmiObject -Class Win32_Printer -ErrorAction SilentlyContinue | Where-Object { 
            $_.Name -like "*$printer*" -or $_.ShareName -like "*$printer*" 
        }
        
        if ($wmiPrinter) {
            $printerFound = $true
            Write-Host "Printer found via WMI: $($wmiPrinter.Name)"
        }
        
        if ($printerFound) {
            Write-Host "SUCCESS: Printer installed globally"
        } else {
            Write-Host "INFO: Printer deployed. May require user logoff/logon to appear."
        }
        
        exit 0
    }
    catch {
        Write-Error "Installation failed: $($_.Exception.Message)"
        exit 1
    }
    finally {
        # Cleanup authentication
        Write-Host "Cleaning up authentication session..."
        & net.exe use "\\$server\IPC$" /delete 2>&1 | Out-Null
    }
  register: printer_install
  changed_when: "'SUCCESS' in printer_install.stdout or 'INFO: Printer deployed' in printer_install.stdout"
  failed_when: printer_install.rc != 0