---
# Reference: ..\..\Semaphore_Printer_Deployment_Guide.md
- name: Deploy Network Printer
  hosts: "{{ target_host }}"
  gather_facts: no
  vars:
    # Connection variables (populated from Semaphore Survey)
    ansible_user: "{{ target_username }}"
    ansible_password: "{{ target_password }}"
    ansible_connection: winrm
    ansible_winrm_server_cert_validation: ignore
    ansible_winrm_transport: ntlm
    ansible_winrm_read_timeout_sec: 90 # Increase timeout for long driver installs

    # Printer Details
    print_server: "HVTRM-WS-PRNT.caliksoa.local"
    # Domain Credentials for Print Server Access
    # Ideally, pass these via Semaphore Environment/Vault
    share_user: "caliksoa\\u13589"
    share_password: "Gaptrm3050+"

  tasks:
    - name: Sanitize Printer Name
      set_fact:
        # Removes brackets and quotes if they are passed from the Semaphore Survey
        clean_printer_name: "{{ printer_name | replace('[', '') | replace(']', '') | replace('\"', '') }}"

    - name: Configure Point and Print Policies (Prevent Driver Prompts)
      win_shell: |
        $p = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint"
        if (!(Test-Path $p)) { New-Item -Path $p -Force | Out-Null }
        Set-ItemProperty -Path $p -Name "RestrictDriverInstallationToAdministrators" -Value 0 -Type DWord -Force
        Set-ItemProperty -Path $p -Name "UpdatePromptSettings" -Value 2 -Type DWord -Force
        Set-ItemProperty -Path $p -Name "NoWarningNoElevationOnInstall" -Value 1 -Type DWord -Force

    - name: Restart Spooler Service (Apply Policies)
      win_service:
        name: Spooler
        state: restarted

    - name: Install Printer (Authenticated Session)
      # Consolidating Auth, Install, and Verify into one task ensures the session persists
      win_shell: |
        $ErrorActionPreference = 'Stop'
        $server = "{{ print_server }}"
        $shortServer = $server.Split('.')[0]
        # Resolve IP to ensure we cover all bases for RPC auth
        try { $serverIP = (Test-Connection -ComputerName $server -Count 1 -ErrorAction Stop).IPV4Address.IPAddressToString } catch { $serverIP = $null }
        
        $printer = "{{ clean_printer_name }}"
        $user = "{{ share_user }}"
        $pass = "{{ share_password }}"
        $fullPath = "\\$server\$printer"

        try {
            # 1. Authenticate
            # Use cmdkey to store credentials for RPC/Spooler access (FQDN, Short Name, and IP)
            & cmdkey /add:$server /user:$user /pass:$pass | Out-Null
            & cmdkey /add:$shortServer /user:$user /pass:$pass | Out-Null
            if ($serverIP) { & cmdkey /add:$serverIP /user:$user /pass:$pass | Out-Null }
            
            # Use net use for SMB access (IPC$)
            $netArgs = @("use", "\\$server\IPC$", "/user:$user", "$pass")
            & net.exe $netArgs 2>&1 | Out-Null
            # Map print$ share to ensure driver access is authenticated
            $netArgsPrint = @("use", "\\$server\print$", "/user:$user", "$pass")
            & net.exe $netArgsPrint 2>&1 | Out-Null

            # 2. Pre-check & Resolve Share Name
            try {
                $remotePrinters = Get-Printer -ComputerName $server -ErrorAction Stop
                Write-Host "Successfully connected to print server RPC."
                
                # Find the printer by Name or ShareName and get the correct ShareName
                $targetPrinter = $remotePrinters | Where-Object { $_.Name -eq $printer -or $_.ShareName -eq $printer } | Select-Object -First 1
                
                if ($targetPrinter) {
                    $printer = $targetPrinter.ShareName
                    $fullPath = "\\$server\$printer"
                    Write-Host "Resolved Printer Share Name: $printer"
                    Write-Host "Target Path: $fullPath"
                } else {
                    Write-Warning "Printer '$printer' not found in remote list. Using provided name."
                }
            } catch {
                Write-Warning "Could not list remote printers (RPC check failed). Installation might fail."
            }

            # 3. Install (Global Add)
            # /ga is asynchronous, so we launch it and wait
            $printArgs = "printui.dll,PrintUIEntry /ga /n`"$fullPath`" /q"
            Start-Process rundll32.exe -ArgumentList $printArgs
            Start-Sleep -Seconds 60

            # 4. Restart Spooler to register the global printer
            Restart-Service Spooler -Force
            
            # Wait for Spooler to be fully running
            $timeout = 0
            while ((Get-Service Spooler).Status -ne 'Running' -and $timeout -lt 30) {
                Start-Sleep -Seconds 1
                $timeout++
            }
            Start-Sleep -Seconds 10 # Extra buffer for RPC endpoints to register

            # 5. Verify and Fallback
            # Check if printer exists by name (partial match to be safe against FQDN vs NetBIOS differences)
            $installed = Get-Printer | Where-Object { $_.Name -eq $fullPath -or $_.Name -like "*$printer*" }
            if (-not $installed) {
                Write-Warning "Global Add failed or delayed. Attempting PowerShell Add-Printer..."
                try {
                    Add-Printer -ConnectionName $fullPath -ErrorAction Stop
                } catch {
                    Write-Warning "FQDN Add-Printer failed: $($_.Exception.Message)"
                    
                    # Try COM Object as intermediate fallback (often works better for auth)
                    try {
                        Write-Host "Attempting WScript.Network COM object..."
                        (New-Object -ComObject WScript.Network).AddWindowsPrinterConnection($fullPath)
                    } catch {
                        Write-Warning "COM Object failed: $($_.Exception.Message)"
                        if ($serverIP) {
                            $ipPath = "\\$serverIP\$printer"
                            Write-Host "Trying IP-based path: $ipPath"
                            Add-Printer -ConnectionName $ipPath -ErrorAction Stop
                        } else {
                            throw $_
                        }
                    }
                }
            }
            Write-Host "Printer installed successfully."
        }
        finally {
            # 6. Cleanup
            & net.exe use "\\$server\IPC$" /delete 2>&1 | Out-Null
            & net.exe use "\\$server\print$" /delete 2>&1 | Out-Null
            & cmdkey /delete:$server 2>&1 | Out-Null
            & cmdkey /delete:$shortServer 2>&1 | Out-Null
            if ($serverIP) { & cmdkey /delete:$serverIP 2>&1 | Out-Null }
        }