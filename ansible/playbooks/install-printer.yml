---
# Reference: ..\..\Semaphore_Printer_Deployment_Guide.md
- name: Deploy Network Printer
  hosts: "{{ target_host }}"
  gather_facts: no
  vars:
    # Connection variables (populated from Semaphore Survey)
    ansible_user: "{{ target_username }}"
    ansible_password: "{{ target_password }}"
    ansible_connection: winrm
    ansible_winrm_server_cert_validation: ignore
    ansible_winrm_transport: ntlm

    # Printer Details
    print_server: "HVTRM-WS-PRNT.caliksoa.local"
    # Domain Credentials for Print Server Access
    # Ideally, pass these via Semaphore Environment/Vault
    share_user: "caliksoa\\u13589"
    share_password: "Gaptrm3050+"

  tasks:
    - name: Sanitize Printer Name
      set_fact:
        # Removes brackets and quotes if they are passed from the Semaphore Survey
        clean_printer_name: "{{ printer_name | replace('[', '') | replace(']', '') | replace('\"', '') }}"

    - name: Configure Point and Print Policies (Prevent Driver Prompts)
      win_shell: |
        $p = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint"
        if (!(Test-Path $p)) { New-Item -Path $p -Force | Out-Null }
        Set-ItemProperty -Path $p -Name "RestrictDriverInstallationToAdministrators" -Value 0 -Type DWord -Force
        Set-ItemProperty -Path $p -Name "UpdatePromptSettings" -Value 2 -Type DWord -Force

    - name: Restart Spooler Service (Apply Policies)
      win_service:
        name: Spooler
        state: restarted

    - name: Authenticate to Print Server (IPC$)
      # We map the IPC$ share to establish a valid Kerberos/NTLM session with the server
      win_command: 'net use \\{{ print_server }}\IPC$ /user:{{ share_user }} {{ share_password }}'

    - name: Add Printer Globally
      # /ga = Global Add (per-machine connection)
      # /n = Printer Name
      win_command: 'rundll32 printui.dll,PrintUIEntry /ga /n"\\{{ print_server }}\{{ clean_printer_name }}" /q'

    - name: Restart Spooler Service (Finalize Install)
      # Required for Global Add changes to take effect
      win_service:
        name: Spooler
        state: restarted

    - name: Verify Printer Installation
      win_shell: |
        $printerName = "{{ clean_printer_name }}"
        $fullPath = "\\{{ print_server }}\$printerName"
        if (-not (Get-Printer -Name $fullPath -ErrorAction SilentlyContinue)) {
            # Attempt to add via PowerShell to capture the specific error message
            try {
                Add-Printer -ConnectionName $fullPath -ErrorAction Stop
                Write-Warning "Printer was added via PowerShell (Per-User) because Global Add failed silently."
            } catch {
                Write-Error "Printer installation failed. Error: $($_.Exception.Message)"
            }
        }

    - name: Remove Authentication
      win_command: 'net use \\{{ print_server }}\IPC$ /delete'
      ignore_errors: yes