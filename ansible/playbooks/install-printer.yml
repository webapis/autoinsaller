---
# Reference: ..\..\Semaphore_Printer_Deployment_Guide.md
- name: Deploy Network Printer
  hosts: "{{ target_host }}"
  gather_facts: no
  vars:
    # Connection variables (populated from Semaphore Survey)
    ansible_user: "{{ target_username }}"
    ansible_password: "{{ target_password }}"
    ansible_connection: winrm
    ansible_winrm_server_cert_validation: ignore
    ansible_winrm_transport: ntlm
    ansible_winrm_read_timeout_sec: 90 # Increase timeout for long driver installs

    # Printer Details
    print_server: "HVTRM-WS-PRNT.caliksoa.local"
    # Domain Credentials for Print Server Access
    # Ideally, pass these via Semaphore Environment/Vault
    share_user: "caliksoa\\u13589"
    share_password: "Gaptrm3050+"

  tasks:
    - name: Sanitize Printer Name
      set_fact:
        # Removes brackets and quotes if they are passed from the Semaphore Survey
        clean_printer_name: "{{ printer_name | replace('[', '') | replace(']', '') | replace('\"', '') }}"

    - name: Configure Point and Print Policies (Prevent Driver Prompts)
      win_shell: |
        $p = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint"
        if (!(Test-Path $p)) { New-Item -Path $p -Force | Out-Null }
        Set-ItemProperty -Path $p -Name "RestrictDriverInstallationToAdministrators" -Value 0 -Type DWord -Force
        Set-ItemProperty -Path $p -Name "UpdatePromptSettings" -Value 2 -Type DWord -Force

    - name: Restart Spooler Service (Apply Policies)
      win_service:
        name: Spooler
        state: restarted

    - name: Install Printer (Authenticated Session)
      # Consolidating Auth, Install, and Verify into one task ensures the session persists
      win_shell: |
        $ErrorActionPreference = 'Stop'
        $server = "{{ print_server }}"
        $shortServer = $server.Split('.')[0]
        $printer = "{{ clean_printer_name }}"
        $user = "{{ share_user }}"
        $pass = "{{ share_password }}"
        $fullPath = "\\$server\$printer"

        try {
            # 1. Authenticate
            # Use cmdkey to store credentials for RPC/Spooler access (FQDN and Short Name)
            & cmdkey /add:$server /user:$user /pass:$pass | Out-Null
            & cmdkey /add:$shortServer /user:$user /pass:$pass | Out-Null
            
            # Use net use for SMB access (IPC$)
            $netArgs = @("use", "\\$server\IPC$", "/user:$user", "$pass")
            & net.exe $netArgs 2>&1 | Out-Null

            # 2. Pre-check: Verify RPC access by listing remote printers
            try {
                Get-Printer -ComputerName $server -ErrorAction Stop | Out-Null
                Write-Host "Successfully connected to print server RPC."
            } catch {
                Write-Warning "Could not list remote printers (RPC check failed). Installation might fail."
            }

            # 3. Install (Global Add)
            # /ga is asynchronous, so we launch it and wait
            $printArgs = "printui.dll,PrintUIEntry /ga /n`"$fullPath`" /q"
            Start-Process rundll32.exe -ArgumentList $printArgs
            Start-Sleep -Seconds 45

            # 4. Restart Spooler to register the global printer
            Restart-Service Spooler -Force
            
            # Wait for Spooler to be fully running
            $timeout = 0
            while ((Get-Service Spooler).Status -ne 'Running' -and $timeout -lt 30) {
                Start-Sleep -Seconds 1
                $timeout++
            }

            # 5. Verify and Fallback
            # Check if printer exists by name (partial match to be safe against FQDN vs NetBIOS differences)
            $installed = Get-Printer | Where-Object { $_.Name -eq $fullPath -or $_.Name -like "*$printer*" }
            if (-not $installed) {
                Write-Warning "Global Add failed or delayed. Attempting PowerShell Add-Printer..."
                Add-Printer -ConnectionName $fullPath -ErrorAction Stop
            }
            Write-Host "Printer installed successfully."
        }
        finally {
            # 6. Cleanup
            & net.exe use "\\$server\IPC$" /delete 2>&1 | Out-Null
            & cmdkey /delete:$server 2>&1 | Out-Null
            & cmdkey /delete:$shortServer 2>&1 | Out-Null
        }