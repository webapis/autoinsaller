---
# Reference: ..\..\Semaphore_Printer_Deployment_Guide.md
- name: Deploy Network Printer
  hosts: "{{ target_host }}"
  gather_facts: no
  vars:
    # Connection variables (populated from Semaphore Survey)
    ansible_user: "{{ target_username }}"
    ansible_password: "{{ target_password }}"
    ansible_connection: winrm
    ansible_winrm_server_cert_validation: ignore
    ansible_winrm_transport: ntlm

    # Printer Details
    print_server: "HVTRM-WS-PRNT.caliksoa.local"
    # Domain Credentials for Print Server Access
    # Ideally, pass these via Semaphore Environment/Vault
    share_user: "caliksoa\\u13589"
    share_password: "Gaptrm3050+"

  tasks:
    - name: Sanitize Printer Name
      set_fact:
        # Removes brackets and quotes if they are passed from the Semaphore Survey
        clean_printer_name: "{{ printer_name | replace('[', '') | replace(']', '') | replace('\"', '') }}"

    - name: Configure Point and Print Policies (Prevent Driver Prompts)
      win_shell: |
        $p = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint"
        if (!(Test-Path $p)) { New-Item -Path $p -Force | Out-Null }
        Set-ItemProperty -Path $p -Name "RestrictDriverInstallationToAdministrators" -Value 0 -Type DWord -Force
        Set-ItemProperty -Path $p -Name "UpdatePromptSettings" -Value 2 -Type DWord -Force

    - name: Restart Spooler Service (Apply Policies)
      win_service:
        name: Spooler
        state: restarted

    - name: Install Printer (Authenticated Session)
      # Consolidating Auth, Install, and Verify into one task ensures the session persists
      win_shell: |
        $ErrorActionPreference = 'Stop'
        $server = "{{ print_server }}"
        $printer = "{{ clean_printer_name }}"
        $user = "{{ share_user }}"
        $pass = "{{ share_password }}"
        $fullPath = "\\$server\$printer"

        try {
            # 1. Authenticate
            # Use net.exe directly to handle special chars better and capture errors
            $netArgs = @("use", "\\$server\IPC$", "/user:$user", "$pass")
            & net.exe $netArgs 2>&1 | Out-Null

            # 2. Install (Global Add)
            # /ga is asynchronous, so we launch it and wait
            $printArgs = "printui.dll,PrintUIEntry /ga /n`"$fullPath`" /q"
            Start-Process rundll32.exe -ArgumentList $printArgs
            Start-Sleep -Seconds 30

            # 3. Restart Spooler to register the global printer
            Restart-Service Spooler -Force
            Start-Sleep -Seconds 10

            # 4. Verify and Fallback
            # Check if printer exists by name (partial match to be safe against FQDN vs NetBIOS differences)
            $installed = Get-Printer | Where-Object { $_.Name -eq $fullPath -or $_.Name -like "*$printer*" }
            if (-not $installed) {
                Write-Warning "Global Add failed or delayed. Attempting PowerShell Add-Printer..."
                Add-Printer -ConnectionName $fullPath -ErrorAction Stop
            }
            Write-Host "Printer installed successfully."
        }
        finally {
            # 5. Cleanup
            & net.exe use "\\$server\IPC$" /delete 2>&1 | Out-Null
        }