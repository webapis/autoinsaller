---
- name: Register Target Host from Semaphore Survey
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Add Dynamic Host
      add_host:
        name: "{{ target_host }}"
        groups: deployment_targets
        ansible_user: "{{ target_username }}"
        ansible_password: "{{ target_password }}"
        ansible_connection: winrm
        ansible_port: 5985
        ansible_winrm_scheme: http
        ansible_winrm_transport: ntlm
        ansible_winrm_server_cert_validation: ignore

- name: Deploy Shared Printers (Global)
  hosts: deployment_targets
  gather_facts: no
  vars:
    # Configuration
    print_server: "HVTRM-WS-PRNT.caliksoa.local"
    # selected_printer variable is expected from Semaphore Survey
    
    # Credentials (for authenticating to the Print Server share)
    # Note: share_password should be defined in Semaphore Environment/Secrets
    share_user: "caliksoa\\srv-gap-cppm"
    share_password: "{{ share_password }}" 

  tasks:
    - name: Verify Selected Printer
      debug:
        msg: "Installing printer: {{ selected_printer }}"

    - name: Authenticate to Print Server
      # We map the 'print$' share to establish a valid session with Domain Credentials
      ansible.windows.win_mapped_drive:
        letter: P
        path: "\\\\{{ print_server }}\\print$"
        username: "{{ share_user }}"
        password: "{{ share_password }}"
        state: present

    # FIX: Disable "Point and Print" restrictions to prevent driver install prompts (which cause hangs)
    - name: Allow Point and Print (RestrictDriverInstallationToAdministrators = 0)
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint
        name: RestrictDriverInstallationToAdministrators
        data: 0
        type: dword
        state: present

    - name: Disable Point and Print Warnings (UpdatePromptSettings = 2)
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint
        name: UpdatePromptSettings
        data: 2
        type: dword
        state: present

    - name: Add Selected Printer (Global Machine Connection)
      win_shell: |
        rundll32 printui.dll,PrintUIEntry /ga /n"\\{{ print_server }}\{{ selected_printer }}" /q
      register: printer_out
      failed_when: printer_out.rc != 0 and printer_out.rc != 0x00000057 # Ignore 'already exists' errors

    - name: Restart Spooler
      # Required for Global connections to appear in the UI immediately
      win_service:
        name: Spooler
        state: restarted

    - name: Unmap Auth Drive
      ansible.windows.win_mapped_drive:
        letter: P
        state: absent

    # Security Cleanup: Revert Point and Print restrictions to defaults
    - name: Revert Point and Print (RestrictDriverInstallationToAdministrators)
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint
        name: RestrictDriverInstallationToAdministrators
        state: absent

    - name: Revert Point and Print Warnings (UpdatePromptSettings)
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint
        name: UpdatePromptSettings
        state: absent