---
# Reference: ..\..\Semaphore_List_Software_Guide.md
- name: List Installed Software
  hosts: "{{ target_host }}"
  gather_facts: no
  vars:
    # Connection variables (populated from Semaphore Survey)
    ansible_user: "{{ target_username }}"
    ansible_password: "{{ target_password }}"
    ansible_connection: winrm
    ansible_winrm_server_cert_validation: ignore
    ansible_winrm_transport: ntlm

  tasks:
    - name: Gather Installed Software (Registry)
      win_shell: |
        $keys = 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*', 'HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*'
        Get-ItemProperty $keys -ErrorAction SilentlyContinue | 
        Select-Object DisplayName, DisplayVersion, Publisher | 
        Where-Object { $_.DisplayName -ne $null } | 
        Sort-Object DisplayName
      register: software_list

    - name: Display Software List
      debug:
        var: software_list.stdout_lines