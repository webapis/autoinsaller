---
- name: Register Target Host from Semaphore Survey
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Add Dynamic Host
      add_host:
        name: "{{ target_host }}"
        groups: deployment_targets
        ansible_user: "{{ target_username }}"
        ansible_password: "{{ target_password }}"
        ansible_connection: winrm
        ansible_winrm_transport: credssp
        ansible_winrm_server_cert_validation: ignore

- name: Uninstall Shared Printer (Global)
  hosts: deployment_targets
  gather_facts: no
  vars:
    print_server: "HVTRM-WS-PRNT.caliksoa.local"
    # selected_printer variable is expected from Semaphore Survey

  tasks:
    - name: Debug Printer to Remove
      debug:
        msg: "Uninstalling printer: {{ selected_printer }}"

    - name: Remove Selected Printer
      win_shell: |
        rundll32 printui.dll,PrintUIEntry /gd /n"\\{{ print_server }}\{{ selected_printer }}" /q
      register: printer_out
      # /gd = Global Delete
      # 0x00000057 / 0x00000709 = Printer not found (safe to ignore)
      failed_when: 
        - printer_out.rc != 0
        - printer_out.rc != 0x00000057 
        - printer_out.rc != 0x00000709

    - name: Restart Spooler
      # Required to refresh the UI
      win_service:
        name: Spooler
        state: restarted